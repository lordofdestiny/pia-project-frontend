<div class="mat-elevation-z12">
    <h2 class="register-title">Register</h2>

    <form id="registerForm" [formGroup]="registerForm" enctype="multipart/form-data">
        <mat-stepper [orientation]="(stepperOrientation | async)!" formArrayName="formArray" labelPosition="bottom"
            animationDuration="400" [linear]="false">

            <mat-step [formGroupName]="0" *ngVar="formArray?.get([0]); let group" [stepControl]="group"
                [errorMessage]="getStepErrorMessage(0)" state="full_name">
                <ng-template matStepLabel>Name</ng-template>
                <mat-form-field appearance="fill">
                    <mat-label>First name</mat-label>
                    <input matInput id="first_name" type="text" formControlName="first_name" autocomplete="given-name"
                        autocapitalize="words" autofocus />
                    <mat-error>First name is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                    <mat-label>Last name</mat-label>
                    <input matInput id="last_name" type="text" formControlName="last_name" autocomplete="family-name"
                        autocapitalize="words" />
                    <mat-error>Last name is required</mat-error>
                </mat-form-field>
                <div class="nav-buttons">
                    <div></div>
                    <button mat-stroked-button matStepperNext>Next</button>
                </div>
            </mat-step>

            <mat-step [formGroupName]="1" *ngVar="formArray?.get([1]); let group" [stepControl]="group"
                [errorMessage]="getStepErrorMessage(1)" state="identity">
                <ng-template matStepLabel>Identity</ng-template>
                <mat-form-field appearance="fill" *ngVar="group.get('email'); let email">
                    <mat-label>E-mail</mat-label>
                    <input matInput id="email" type="email" formControlName="email" autocomplete="email"
                        [errorStateMatcher]="matcher" />
                    <mat-error *ngIf="email.hasError('required')">
                        Email is required
                    </mat-error>
                    <mat-error *ngIf="email.hasError('pattern')">
                        Email format is not valid
                    </mat-error>
                    <mat-error *ngIf="email.hasError('notuniqueEmail')">
                        Email is already taken
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill" *ngVar="group.get('username'); let username">
                    <mat-label>Username</mat-label>
                    <input matInput id="username" type="text" formControlName="username" autocomplete="username"
                        [errorStateMatcher]="matcher" />
                    <mat-error *ngIf="username.hasError('required')">Username is required</mat-error>
                    <mat-error *ngIf="username.hasError('pattern')">Username format is not valid </mat-error>
                    <mat-error *ngIf="username.hasError('minlength')">Username must be at least 4
                        charachters</mat-error>
                    <mat-error *ngIf="username.hasError('maxlength')">Username must be at most 16
                        charachters</mat-error>
                    <mat-error *ngIf="username.hasError('notuniqueUsername')"> Username is already taken</mat-error>
                </mat-form-field>
                <div class="nav-buttons">
                    <button mat-stroked-button matStepperPrevious>Back</button>
                    <button mat-stroked-button matStepperNext>Next</button>
                </div>
            </mat-step>

            <mat-step [formGroupName]="2" *ngVar="formArray?.get([2]); let group" [stepControl]="group"
                [errorMessage]="getStepErrorMessage(2)" state="contact">
                <ng-template matStepLabel>Contact</ng-template>

                <mat-form-field appearance="fill" *ngVar="group.get('phone'); let phone">
                    <mat-label>Phone number</mat-label>
                    <input matInput id="phone" type="tel" formControlName="phone" autocomplete="tel-national"
                        [errorStateMatcher]="matcher" />
                    <mat-error *ngIf="phone.hasError('required')">Phone number is required</mat-error>
                    <mat-error *ngIf="phone.hasError('pattern')">Phone number format is not valid</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                    <mat-label>Address</mat-label>
                    <input matInput id="address" type="text" formControlName="address" autocomplete="address-line1"
                        [errorStateMatcher]="matcher" />
                    <mat-error>This field is required</mat-error>
                </mat-form-field>
                <div class="nav-buttons">
                    <button mat-stroked-button matStepperPrevious>Back</button>
                    <button mat-stroked-button matStepperNext>Next</button>
                </div>
            </mat-step>


            <mat-step [formGroupName]="3" *ngVar="formArray?.get([3]); let group" [stepControl]="group"
                [errorMessage]="getStepErrorMessage(3)" state="password">
                <ng-template matStepLabel>Password</ng-template>

                <mat-form-field appearance="fill" *ngVar="group.get('password'); let pwd">
                    <mat-label>New password</mat-label>
                    <input matInput id="password" [type]="passwordHidden?'text':'password'" formControlName="password"
                        autocomplete="new-password" [errorStateMatcher]="matcher" />

                    <button type='button' mat-icon-button matSuffix [attr.aria-label]="'Hide password'"
                        (click)="togglePassword($event)" (touchstart)="togglePassword($event)"
                        (touchend)="togglePassword($event)" tabindex="-1">
                        <mat-icon> {{passwordHidden ? 'visibility_off':'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="pwd.hasError('required')"> Password is required</mat-error>
                    <mat-error *ngIf="pwd.hasError('minlength')">
                        Password must be at least 8 charachters long</mat-error>
                    <mat-error *ngIf="pwd.hasError('maxlength')">
                        Password can be at most 14 charachters long
                    </mat-error>
                    <mat-error *ngIf="pwd.hasError('pattern') ">
                        Password is not secure enough</mat-error>
                </mat-form-field>
                <table class="password_reqs" *ngVar="group.get('password'); let pwd">
                    <tr *ngFor="let check of passwordChecks">
                        <td *ngVar="check.regex.test(pwd.value); let valid">
                            <mat-icon *ngIf="!pwd.dirty" color="accent">help</mat-icon>
                            <mat-icon *ngIf="pwd.dirty && valid" color="primary">check</mat-icon>
                            <mat-icon *ngIf="pwd.dirty && !valid" color="warn">cancel</mat-icon>
                        </td>
                        <td><span>{{check.error}}</span></td>
                    </tr>
                </table>

                <mat-form-field appearance="fill" *ngVar="group.get('confirm_password'); let cpwd">
                    <mat-label>Confirm password</mat-label>
                    <input matInput id="confirm_password" type="password" formControlName="confirm_password"
                        autocomplete="new-password" [errorStateMatcher]="confirmPasswordMatcher" />
                    <mat-error *ngIf="cpwd.hasError('required')">Please confirm your password </mat-error>
                    <mat-error *ngIf="group.hasError('mismatch')">
                        Passwords do not match
                    </mat-error>
                </mat-form-field>
                <div class="nav-buttons">
                    <button mat-stroked-button matStepperPrevious>Back</button>
                    <button mat-stroked-button matStepperNext>Next</button>
                </div>
            </mat-step>

            <mat-step [formGroupName]="4" *ngVar="formArray?.get([4]); let group" [stepControl]="group"
                [optional]="true" state="picture">
                <ng-template matStepLabel>Picture</ng-template>
                <ng-container *ngVar="group.get('profile_picture'); let pic">
                    <mat-form-field appearance="fill">
                        <mat-label>Profile picture</mat-label>

                        <ngx-mat-file-input formControlName="profile_picture" type="file" accept="image/*"
                            color="accent">
                            <mat-icon ngxMatFileInputIcon>
                                image
                            </mat-icon>
                        </ngx-mat-file-input>
                        <mat-error *ngIf="pic.hasError('tooSmall')">
                            Image has to be at least 100px &times; 100px
                        </mat-error>
                        <mat-error *ngIf="pic.hasError('tooBig')">
                            Image has to be at most 300px &times; 300px
                        </mat-error>
                        <mat-error *ngIf="pic.hasError('notImage')">
                            You have to select an image
                        </mat-error>
                    </mat-form-field>
                    <img #preview id="image_preview" alt="Image preview"
                        [style.display]="pic.value!=='' && pic.valid ? 'block':'none'">

                    <button *ngIf="pic.value!=='' && pic.dirty" type="button" mat-stroked-button color="accent"
                        (click)="pic.setValue('')">
                        Clear
                    </button>
                </ng-container>

                <div class="nav-buttons">
                    <button mat-stroked-button matStepperPrevious>Back</button>
                    <button mat-stroked-button matStepperNext>Next</button>
                </div>
            </mat-step>

            <mat-step state="complete">
                <ng-template matStepLabel>Done</ng-template>
                <div class="last_page">
                    <p *ngIf="registerForm.valid">
                        You're all set. Please click <b>Submit</b> to register.
                    </p>
                    <p *ngIf="!registerForm.valid" [style.color]="'var(--warn)'">
                        Some fields were not populated or have errors.<br />
                        Corect them in order to register.
                    </p>
                </div>
                <button mat-raised-button color="primary" (click)="onSubmit(registerModal)"
                    [disabled]="!registerForm.valid">Submit</button>

            </mat-step>

            <ng-template matStepperIcon="full_name">
                <mat-icon>perm_identity</mat-icon>
            </ng-template>
            <ng-template matStepperIcon="identity">
                <mat-icon>verified_user</mat-icon>
            </ng-template>
            <ng-template matStepperIcon="contact">
                <mat-icon>call</mat-icon>
            </ng-template>
            <ng-template matStepperIcon="password">
                <mat-icon>lock</mat-icon>
            </ng-template>
            <ng-template matStepperIcon="picture">
                <mat-icon>face</mat-icon>
            </ng-template>
            <ng-template matStepperIcon="complete">
                <mat-icon>check_circle_outline</mat-icon>
            </ng-template>
            <ng-template matStepperIcon="done">
                <mat-icon>check</mat-icon>
            </ng-template>

        </mat-stepper>
    </form>
</div>

<ng-template #registerModal>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Modal</h4>
        <button type="button" class="btn-close close pull-right" aria-label="Close" (click)="modalRef?.hide()">
            <span aria-hidden="true" class="visually-hidden">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        Your registration has been submitted. Please wait for an administrator to approve your account.
    </div>
</ng-template>